---
# tasks file for backup_restore
  - name: copy systemdb_restore.sh
    template:
      src: systemdb_restore.sh
      dest: /tmp/systemdb_restore.sh
      group: sapsys
      owner: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"
      force: yes
      mode: u=rwx,g=rx,o=rx
    become: yes

  - name: copy tenantdb_restore.sh
    template:
      src: tenantdb_restore.sh
      dest: /tmp/tenantdb_restore.sh
      group: sapsys
      owner: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"
      force: yes
      mode: u=rwx,g=rx,o=rx
    become: yes

  - name: copy stopsap.sh
    template:
      src: stopsap.sh
      dest: /tmp/stopsap.sh
      group: sapsys
      owner: "{{ lookup('ini', 'sid section=SAP file={{ config_file_path }} ')|lower }}adm"
      force: yes
      mode: u=rwx,g=rx,o=rx
    become: yes

  - name: copy startsap.sh
    template:
      src: startsap.sh
      dest: /tmp/startsap.sh
      group: sapsys
      owner: "{{ lookup('ini', 'sid section=SAP file={{ config_file_path }} ')|lower }}adm"
      force: yes
      mode: u=rwx,g=rx,o=rx
    become: yes

  - name: copy db_check.sh
    template:
      src: db_check.sh
      dest: /tmp/db_check.sh
      group: sapsys
      owner: "{{ lookup('ini', 'sid section=SAP file={{ config_file_path }} ')|lower }}adm"
      force: yes
      mode: u=rwx,g=rx,o=rx
    become: yes

  - name: copy stop_db.sh
    template:
      src: stop_db.sh
      dest: /tmp/stop_db.sh
      group: sapsys
      owner: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"
      force: yes
      mode: u=rwx,g=rx,o=rx
    become: yes

  - name: copy user.sql
    template:
      src: user.sql
      dest: /tmp/user.sql
      group: sapsys
      owner: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"
      force: yes
      mode: u=rwx,g=rx,o=rx
    become: yes

  - name: copy user_sql.sh
    template:
      src: user_sql.sh
      dest: /tmp/user_sql.sh
      group: sapsys
      owner: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"
      force: yes
      mode: u=rwx,g=rx,o=rx
    become: yes

  - name: copy schema_change.sh
    template:
      src: schema_change.sh
      dest: /tmp/schema_change.sh
      group: sapsys
      owner: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"
      force: yes
      mode: u=rwx,g=rx,o=rx
    become: yes

  - name: stop sap application
    command: /tmp/stopsap.sh
    become: yes
    become_user: "{{ lookup('ini', 'sid section=SAP file={{ config_file_path }} ')|lower }}adm"

  - name: Waiting for sap application to shut down
    pause:
      seconds: 30

  - name: stop db
    command: /tmp/stop_db.sh
    become: yes
    become_user: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"

  - name: Waiting for db to shut down
    pause:
      seconds: 60

  - name: Run systemdb restore script
    command: /tmp/systemdb_restore.sh
    become: yes
    become_user: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"

  - name: Waiting for systemdb to startup
    pause:
      seconds: 60

  - name: Run user_sql.sh
    command: /tmp/user_sql.sh
    become: yes
    become_user: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"

  - name: Run tenantdb restore script
    command: /tmp/tenantdb_restore.sh
    become: yes
    become_user: "{{ lookup('ini', 'db_sid section=SAP file={{ config_file_path }} ')|lower }}adm"

  - name: Waiting for tenantdb to startup
    pause:
      seconds: 120

  - name: Run schema_change.sh
    command: /tmp/schema_change.sh
    become: yes
    become_user: "{{ lookup('ini', 'sid section=SAP file={{ config_file_path }} ')|lower }}adm"

  - name: Run R3trans
    command: /tmp/db_check.sh
    become: yes
    become_user: "{{ lookup('ini', 'sid section=SAP file={{ config_file_path }} ')|lower }}adm"
    register: check

  - name: Check DB Connection
    fail:
      msg: "DB check connection Failed! Please check R3 trans log /tmp/db_check.log"
    when: '"0000" not in check.stdout'

  - name: Starting SAP
    command: /tmp/startsap.sh
    become: yes
    become_user: "{{ lookup('ini', 'sid section=SAP file={{ config_file_path }} ')|lower }}adm"
    when: '"0000" in check.stdout'

  - name: waiting for SAP to startup
    pause:
      seconds: 60
    when: '"0000" in check.stdout'
